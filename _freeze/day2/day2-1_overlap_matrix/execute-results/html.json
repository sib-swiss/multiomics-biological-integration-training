{
  "hash": "eb22b3c72db54cfcf9730bee573cf787",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Exercise 4\"\neditor: source\neditor_options: \n  chunk_output_type: console\n---\n\n# Overlapping all the datasets\n\n## Learning Objectives\n\nBy the end of this exercise, you will be able to:\n- Load and explore genomic data using Bioconductor classes such as `GRangesList` and `RangedSummarizedExperiment`.\n- Subset and filter genomic features based on annotation or genomic coordinates.\n- Perform basic overlap and distance-based queries between genomic intervals.\n- Integrate multi-assay data (e.g., chromatin marks and gene expression) using shared genomic coordinates.\n\n\n## Load Libraries\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ComplexHeatmap)\nlibrary(EnrichedHeatmap)\nlibrary(SummarizedExperiment)\nlibrary(gUtils)\nlibrary(rtracklayer)\nlibrary(data.table)\nlibrary(parallel)\nlibrary(R.utils)\nlibrary(circlize)\nlibrary(dplyr)\nlibrary(tibble)\n```\n:::\n\n\n## SE objects\n\n::: {.cell}\n\n```{.r .cell-code}\natac <- readRDS(\"data/atac_se.rds\")\nrna <- readRDS(\"data/rna_se.rds\")\nh3k4me3 <- readRDS(\"data/h3k4me3_se.rds\")\nh3k4me1 <- readRDS(\"data/h3k4me1_se.rds\")\nh3k27me3 <- readRDS(\"data/h3k27me3_se.rds\")\nh3k27ac <- readRDS(\"data/h3k27ac_se.rds\")\n```\n:::\n\n\n## Overlap matrix\nTo make the `overlapMatrix` (you could also say `overlapRanges`), we need to identify a target. \n\n## Function to merge Genomic Ranges\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Merge metadata from two GRanges objects based on overlaps\nmetaGR <- function(gr1, gr2, minOverlap = 1) {\n  # Initialize metadata with gr1's metadata\n  mcols_out <- mcols(gr1)\n\n  # Find overlaps (keep all from gr1)\n  hits <- findOverlaps(gr1, gr2, minoverlap = minOverlap)\n  idx1 <- subjectHits(hits)\n  idx2 <- queryHits(hits)\n\n  # Prepare new metadata to be added\n  new_mcols <- DataFrame(matrix(NA, nrow = length(gr1), ncol = ncol(mcols(gr2))))\n  colnames(new_mcols) <- colnames(mcols(gr2))\n  \n  # Fill metadata only for overlaps\n  new_mcols[idx2, ] <- mcols(gr2)[idx1, , drop = FALSE]\n\n  # Combine original and new metadata\n  mcols(gr1) <- cbind(mcols_out, new_mcols)\n  \n  return(gr1)\n}\n```\n:::\n\n\n\n## ATAC-Seq\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract rowRanges and filter peaks with strong signal\nrd_atac <- rowRanges(atac)\nrd_atac <- rd_atac[abs(rd_atac$logFC) >= 0.5 & rd_atac$qvalue <= 0.1]\ncolnames(elementMetadata(rd_atac)) <- paste(\"ATAC\", colnames(elementMetadata(rd_atac)), sep = \"_\")\n```\n:::\n\n\n## RNA\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter differentially expressed genes\nrd_rna <- rowRanges(rna)\nrd_rna <- rd_rna[abs(rd_rna$logFC) >= 0.5 & rd_rna$qvalue <= 0.1]\ncolnames(elementMetadata(rd_rna)) <- paste(\"RNA\", colnames(elementMetadata(rd_rna)), sep = \"_\")\noverlap <- metaGR(gr1 = rd_atac, gr2 = rd_rna, minOverlap = 10)\n```\n:::\n\n\n## ChIP-Seq\n### H3K4me3\n\n::: {.cell}\n\n```{.r .cell-code}\nrd_h3k4me3 <- rowRanges(h3k4me3)\nrd_h3k4me3 <- rd_h3k4me3[abs(rd_h3k4me3$logFC) >= 0.5 & rd_h3k4me3$qvalue <= 0.1]\ncolnames(elementMetadata(rd_h3k4me3)) <- paste(\"H3K4me3\", colnames(elementMetadata(rd_h3k4me3)), sep = \"_\")\noverlap <- metaGR(gr1 = overlap, gr2 = rd_h3k4me3, minOverlap = 10)\n```\n:::\n\n\n### H3K4me1\n\n::: {.cell}\n\n```{.r .cell-code}\nrd_h3k4me1 <- rowRanges(h3k4me1)\nrd_h3k4me1 <- rd_h3k4me1[abs(rd_h3k4me1$logFC) >= 0.5 & rd_h3k4me1$qvalue <= 0.1]\ncolnames(elementMetadata(rd_h3k4me1)) <- paste(\"H3K4me1\", colnames(elementMetadata(rd_h3k4me1)), sep = \"_\")\noverlap <- metaGR(gr1 = overlap, gr2 = rd_h3k4me1, minOverlap = 10)\n```\n:::\n\n\n### H3K27me3\n\n::: {.cell}\n\n```{.r .cell-code}\nrd_h3k27me3 <- rowRanges(h3k27me3)\nrd_h3k27me3 <- rd_h3k27me3[abs(rd_h3k27me3$logFC) >= 0.5 & rd_h3k27me3$qvalue <= 0.1]\ncolnames(elementMetadata(rd_h3k27me3)) <- paste(\"H3K27me3\", colnames(elementMetadata(rd_h3k27me3)), sep = \"_\")\noverlap <- metaGR(gr1 = overlap, gr2 = rd_h3k27me3, minOverlap = 10)\n```\n:::\n\n\n### H3K27ac\n\n::: {.cell}\n\n```{.r .cell-code}\nrd_h3k27ac <- rowRanges(h3k27ac)\nrd_h3k27ac <- rd_h3k27ac[abs(rd_h3k27ac$logFC) >= 0.5 & rd_h3k27ac$qvalue <= 0.1]\ncolnames(elementMetadata(rd_h3k27ac)) <- paste(\"H3K27ac\", colnames(elementMetadata(rd_h3k27ac)), sep = \"_\")\noverlap <- metaGR(gr1 = overlap, gr2 = rd_h3k27ac, minOverlap = 10)\n```\n:::\n\n\n## Save data\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add a name field and save the final integrated object\noverlap$name <- paste(\"peak\", 1:length(overlap), sep = \"_\")\nnames(overlap) <- overlap$name\n\ndir.create(\"output\", showWarnings = FALSE)\nsaveRDS(object = overlap, file = \"output/overlap_data.rds\")\n```\n:::\n\n\n### Snapshot of overlaMatrix\n\n::: {.cell}\n\n```{.r .cell-code}\noverlap[1:3]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGRanges object with 3 ranges and 109 metadata columns:\n         seqnames          ranges strand |        ATAC_annotation ATAC_geneChr\n            <Rle>       <IRanges>  <Rle> |            <character>    <integer>\n  peak_1     chr1 3670547-3672665      * |       Promoter (<=1kb)            1\n  peak_2     chr1 4332510-4332710      * | Intron (ENSMUST00000..            1\n  peak_3     chr1 4491755-4492573      * |       Promoter (1-2kb)            1\n         ATAC_geneStart ATAC_geneEnd ATAC_geneLength ATAC_geneStrand\n              <integer>    <integer>       <integer>       <integer>\n  peak_1        3214482      3671498          457017               2\n  peak_2        4344146      4360314           16169               2\n  peak_3        4492465      4493735            1271               2\n         ATAC_geneId    ATAC_transcriptId ATAC_distanceToTSS       ATAC_ENSEMBL\n         <character>          <character>          <numeric>        <character>\n  peak_1      497097 ENSMUST00000070533.4                  0 ENSMUSG00000051951\n  peak_2       19888 ENSMUST00000027032.5              27604 ENSMUSG00000025900\n  peak_3       20671 ENSMUST00000191939.1               1162 ENSMUSG00000025902\n         ATAC_SYMBOL          ATAC_GENENAME   ATAC_anno ATAC_logFC ATAC_logCPM\n         <character>            <character> <character>  <numeric>   <numeric>\n  peak_1        Xkr4 X-linked Kx blood gr..    Promoter   0.602984    10.45378\n  peak_2         Rp1 retinitis pigmentosa..      Intron   0.855748     5.18424\n  peak_3       Sox17 SRY (sex determining..    Promoter  -0.620926     7.13469\n            ATAC_F ATAC_PValue ATAC_qvalue      RNA_Row.names RNA_gene_id\n         <numeric>   <numeric>   <numeric>        <character> <character>\n  peak_1  41.78446 6.58453e-08 4.81983e-07 ENSMUSG00000051951      497097\n  peak_2   3.68371 6.13517e-02 9.28785e-02               <NA>        <NA>\n  peak_3   9.14522 4.12368e-03 8.38540e-03               <NA>        <NA>\n          RNA_SYMBOL           RNA_GENENAME        RNA_ENSEMBL RNA_geneLength\n         <character>            <character>        <character>      <integer>\n  peak_1        Xkr4 X-linked Kx blood gr.. ENSMUSG00000051951         457017\n  peak_2        <NA>                   <NA>               <NA>           <NA>\n  peak_3        <NA>                   <NA>               <NA>           <NA>\n         RNA_geneChr RNA_geneStart RNA_geneEnd RNA_geneStrand  RNA_geneId\n         <character>     <integer>   <integer>    <character> <character>\n  peak_1        chr1       3214482     3671498              -      497097\n  peak_2        <NA>          <NA>        <NA>           <NA>        <NA>\n  peak_3        <NA>          <NA>        <NA>           <NA>        <NA>\n             RNA_transcriptId    RNA_anno RNA_logFC RNA_logCPM     RNA_F\n                  <character> <character> <numeric>  <numeric> <numeric>\n  peak_1 ENSMUST00000070533.4        Gene   1.37498    5.62452   33.7077\n  peak_2                 <NA>        <NA>        NA         NA        NA\n  peak_3                 <NA>        <NA>        NA         NA        NA\n         RNA_PValue RNA_qvalue H3K4me3_annotation H3K4me3_geneChr\n          <numeric>  <numeric>        <character>       <integer>\n  peak_1 0.00224273 0.00628871   Promoter (<=1kb)               1\n  peak_2         NA         NA               <NA>            <NA>\n  peak_3         NA         NA               <NA>            <NA>\n         H3K4me3_geneStart H3K4me3_geneEnd H3K4me3_geneLength\n                 <integer>       <integer>          <integer>\n  peak_1           3214482         3671498             457017\n  peak_2              <NA>            <NA>               <NA>\n  peak_3              <NA>            <NA>               <NA>\n         H3K4me3_geneStrand H3K4me3_geneId H3K4me3_transcriptId\n                  <integer>    <character>          <character>\n  peak_1                  2         497097 ENSMUST00000070533.4\n  peak_2               <NA>           <NA>                 <NA>\n  peak_3               <NA>           <NA>                 <NA>\n         H3K4me3_distanceToTSS    H3K4me3_ENSEMBL H3K4me3_SYMBOL\n                     <numeric>        <character>    <character>\n  peak_1                     0 ENSMUSG00000051951           Xkr4\n  peak_2                    NA               <NA>           <NA>\n  peak_3                    NA               <NA>           <NA>\n               H3K4me3_GENENAME H3K4me3_anno H3K4me3_logFC H3K4me3_logCPM\n                    <character>  <character>     <numeric>      <numeric>\n  peak_1 X-linked Kx blood gr..     Promoter      0.607114        9.26749\n  peak_2                   <NA>         <NA>            NA             NA\n  peak_3                   <NA>         <NA>            NA             NA\n         H3K4me3_F H3K4me3_PValue H3K4me3_qvalue H3K4me1_annotation\n         <numeric>      <numeric>      <numeric>        <character>\n  peak_1   135.443    4.65079e-31    1.28968e-29               <NA>\n  peak_2        NA             NA             NA               <NA>\n  peak_3        NA             NA             NA               <NA>\n         H3K4me1_geneChr H3K4me1_geneStart H3K4me1_geneEnd H3K4me1_geneLength\n               <integer>         <integer>       <integer>          <integer>\n  peak_1            <NA>              <NA>            <NA>               <NA>\n  peak_2            <NA>              <NA>            <NA>               <NA>\n  peak_3            <NA>              <NA>            <NA>               <NA>\n         H3K4me1_geneStrand H3K4me1_geneId H3K4me1_transcriptId\n                  <integer>    <character>          <character>\n  peak_1               <NA>           <NA>                 <NA>\n  peak_2               <NA>           <NA>                 <NA>\n  peak_3               <NA>           <NA>                 <NA>\n         H3K4me1_distanceToTSS H3K4me1_ENSEMBL H3K4me1_SYMBOL H3K4me1_GENENAME\n                     <numeric>     <character>    <character>      <character>\n  peak_1                    NA            <NA>           <NA>             <NA>\n  peak_2                    NA            <NA>           <NA>             <NA>\n  peak_3                    NA            <NA>           <NA>             <NA>\n         H3K4me1_anno H3K4me1_logFC H3K4me1_logCPM H3K4me1_F H3K4me1_PValue\n          <character>     <numeric>      <numeric> <numeric>      <numeric>\n  peak_1         <NA>            NA             NA        NA             NA\n  peak_2         <NA>            NA             NA        NA             NA\n  peak_3         <NA>            NA             NA        NA             NA\n         H3K4me1_qvalue H3K27me3_annotation H3K27me3_geneChr H3K27me3_geneStart\n              <numeric>         <character>        <integer>          <integer>\n  peak_1             NA                <NA>             <NA>               <NA>\n  peak_2             NA                <NA>             <NA>               <NA>\n  peak_3             NA    Promoter (<=1kb)                1            4492465\n         H3K27me3_geneEnd H3K27me3_geneLength H3K27me3_geneStrand\n                <integer>           <integer>           <integer>\n  peak_1             <NA>                <NA>                <NA>\n  peak_2             <NA>                <NA>                <NA>\n  peak_3          4493735                1271                   2\n         H3K27me3_geneId H3K27me3_transcriptId H3K27me3_distanceToTSS\n             <character>           <character>              <numeric>\n  peak_1            <NA>                  <NA>                     NA\n  peak_2            <NA>                  <NA>                     NA\n  peak_3           20671  ENSMUST00000191939.1                      0\n           H3K27me3_ENSEMBL H3K27me3_SYMBOL      H3K27me3_GENENAME\n                <character>     <character>            <character>\n  peak_1               <NA>            <NA>                   <NA>\n  peak_2               <NA>            <NA>                   <NA>\n  peak_3 ENSMUSG00000025902           Sox17 SRY (sex determining..\n         H3K27me3_anno H3K27me3_logFC H3K27me3_logCPM H3K27me3_F\n           <character>      <numeric>       <numeric>  <numeric>\n  peak_1          <NA>             NA              NA         NA\n  peak_2          <NA>             NA              NA         NA\n  peak_3      Promoter        -1.0597         9.04668    87.0802\n         H3K27me3_PValue H3K27me3_qvalue H3K27ac_annotation H3K27ac_geneChr\n               <numeric>       <numeric>        <character>       <integer>\n  peak_1              NA              NA   Promoter (<=1kb)               1\n  peak_2              NA              NA               <NA>            <NA>\n  peak_3     1.32026e-20     5.28858e-18               <NA>            <NA>\n         H3K27ac_geneStart H3K27ac_geneEnd H3K27ac_geneLength\n                 <integer>       <integer>          <integer>\n  peak_1           3214482         3671498             457017\n  peak_2              <NA>            <NA>               <NA>\n  peak_3              <NA>            <NA>               <NA>\n         H3K27ac_geneStrand H3K27ac_geneId H3K27ac_transcriptId\n                  <integer>    <character>          <character>\n  peak_1                  2         497097 ENSMUST00000070533.4\n  peak_2               <NA>           <NA>                 <NA>\n  peak_3               <NA>           <NA>                 <NA>\n         H3K27ac_distanceToTSS    H3K27ac_ENSEMBL H3K27ac_SYMBOL\n                     <numeric>        <character>    <character>\n  peak_1                     0 ENSMUSG00000051951           Xkr4\n  peak_2                    NA               <NA>           <NA>\n  peak_3                    NA               <NA>           <NA>\n               H3K27ac_GENENAME H3K27ac_anno H3K27ac_logFC H3K27ac_logCPM\n                    <character>  <character>     <numeric>      <numeric>\n  peak_1 X-linked Kx blood gr..     Promoter       1.25269        8.81735\n  peak_2                   <NA>         <NA>            NA             NA\n  peak_3                   <NA>         <NA>            NA             NA\n         H3K27ac_F H3K27ac_PValue H3K27ac_qvalue        name\n         <numeric>      <numeric>      <numeric> <character>\n  peak_1   151.496    1.67395e-34     4.0813e-32      peak_1\n  peak_2        NA             NA             NA      peak_2\n  peak_3        NA             NA             NA      peak_3\n  -------\n  seqinfo: 21 sequences from an unspecified genome; no seqlengths\n```\n\n\n:::\n:::\n\n\n\n# Normalized metrics for plotting\n\nRecommendations based on ENCODE Project Consortium and other literature:\n\n| Assays                     | Typical Window Size (± kb) | Reason / Notes                                 |\n| -------------------------- | -------------------------- | ---------------------------------------------- |\n| **ATAC-seq**               | ±1 kb                      | Narrow peaks, accessibility centered on summit |\n| **H3K4me3**                | ±1 kb to ±2 kb             | Promoter mark, sharp and narrow peaks          |\n| **H3K4me1**                | ±2 kb to ±5 kb             | Enhancer-associated, moderately broad          |\n| **H3K27me3**               | ±5 kb to ±10 kb            | Broad repressive domains                       |\n| **H3K27ac**                | ±2 kb to ±5 kb             | Active enhancers/promoters, broader peaks      |\n\nWe can check the `mean` and `median` of each histone marks and make the `normalizedMatrix` accordingly.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate mean and median widths for each dataset\n\nsummary_table <- tibble(\n  Assay = c(\"ATAC-seq\", \"H3K4me3\", \"H3K4me1\", \"H3K27me3\", \"H3K27ac\"),\n  Mean_Width = c(\n    mean(width(rd_atac)),\n    mean(width(rd_h3k4me3)),\n    mean(width(rd_h3k4me1)),\n    mean(width(rd_h3k27me3)),\n    mean(width(rd_h3k27ac))\n  ),\n  Median_Width = c(\n    median(width(rd_atac)),\n    median(width(rd_h3k4me3)),\n    median(width(rd_h3k4me1)),\n    median(width(rd_h3k27me3)),\n    median(width(rd_h3k27ac))\n  ),\n  Min_Width = c(\n    min(width(rd_atac)),\n    min(width(rd_h3k4me3)),\n    min(width(rd_h3k4me1)),\n    min(width(rd_h3k27me3)),\n    min(width(rd_h3k27ac))\n  ),\n  Max_Width = c(\n    max(width(rd_atac)),\n    max(width(rd_h3k4me3)),\n    max(width(rd_h3k4me1)),\n    max(width(rd_h3k27me3)),\n    max(width(rd_h3k27ac))\n  )\n)\n\nprint(summary_table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 5\n  Assay    Mean_Width Median_Width Min_Width Max_Width\n  <chr>         <dbl>        <dbl>     <int>     <int>\n1 ATAC-seq       956.          932       151      3490\n2 H3K4me3       1316.          749       191     18723\n3 H3K4me1        791.          563       171     12590\n4 H3K27me3      1170.          568       176     23571\n5 H3K27ac        914.          618       171     22276\n```\n\n\n:::\n:::\n\n\n\nAs we restricted the data for this course to just 2 chromosomes, maximum peaks are around 1kb wide. Hence, we will go ahead with `+/- 1kb` windows for our analysis.\n\n\n## Taking 1000 bp around the mid of ATAC-peaks\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extract midpoints of peaks to create windows for visualization\nmid_peaks <- gr.mid(overlap)\n```\n:::\n\n\n## ATAC\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load ATAC bigWig files\natac_files <- list.files(\"data\", pattern = \"ATAC\", full.names = TRUE)\nnames(atac_files) <- gsub(pattern = \"\\\\.bw\", replacement = \"\", x = basename(atac_files))\natac_bw <- lapply(atac_files, function(x){\n  a <- rtracklayer::import(x)\n  a <- a[seqnames(a) %in% c(\"chr1\", \"chr2\")]\n  a\n})\n\n# Normalize signal around mid_peaks\nmat_AS <- lapply(atac_bw, FUN = function(x) {\n  normalizeToMatrix(x, mid_peaks,\n    extend = 1000,\n    value_column = \"score\",\n    include_target = TRUE,\n    mean_mode = \"w0\",\n    w = 20, \n    smooth = T,\n    background = 0\n  )\n})\n\nsaveRDS(mat_AS, file = \"output/mat_atac.rds\")\n```\n:::\n\n\n## ChIP\n\n### H3K4me3\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k4me3_files <- list.files(\"data\", pattern = \"H3K4me3\", full.names = TRUE)\nnames(h3k4me3_files) <- gsub(pattern = \"\\\\.bw\", replacement = \"\", x = basename(h3k4me3_files))\nh3k4me3_bw <- lapply(h3k4me3_files, function(x){\n  a <- rtracklayer::import(x)\n  a <- a[seqnames(a) %in% c(\"chr1\", \"chr2\")]\n  a\n})\n\nmat_h3k4me3 <- lapply(h3k4me3_bw, FUN = function(x) {\n  normalizeToMatrix(x, mid_peaks,\n    extend = 1000,\n    value_column = \"score\",\n    include_target = TRUE,\n    mean_mode = \"w0\",\n    w = 20,\n    smooth = T,\n    background = 0\n  )\n})\n\nsaveRDS(mat_h3k4me3, file = \"output/mat_h3k4me3.rds\")\n```\n:::\n\n\n### H3K4me1\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k4me1_files <- list.files(\"data\", pattern = \"H3K4me1\", full.names = TRUE)\nnames(h3k4me1_files) <- gsub(pattern = \"\\\\.bw\", replacement = \"\", x = basename(h3k4me1_files))\nh3k4me1_bw <- lapply(h3k4me1_files, function(x){\n  a <- rtracklayer::import(x)\n  a <- a[seqnames(a) %in% c(\"chr1\", \"chr2\")]\n  a\n})\n\nmat_h3k4me1 <- lapply(h3k4me1_bw, FUN = function(x) {\n  normalizeToMatrix(x, mid_peaks,\n    extend = 1000,\n    value_column = \"score\",\n    include_target = TRUE,\n    mean_mode = \"w0\",\n    w = 20,\n    smooth = T,\n    background = 0\n  )\n})\n\nsaveRDS(mat_h3k4me1, file = \"output/mat_h3k4me1.rds\")\n```\n:::\n\n\n### H27K4me3\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k27me3_files <- list.files(\"data\", pattern = \"H3K27me3\", full.names = TRUE)\nnames(h3k27me3_files) <- gsub(pattern = \"\\\\.bw\", replacement = \"\", x = basename(h3k27me3_files))\nh3k27me3_bw <- lapply(h3k27me3_files, function(x){\n  a <- rtracklayer::import(x)\n  a <- a[seqnames(a) %in% c(\"chr1\", \"chr2\")]\n  a\n})\n\nmat_h3k27me3 <- lapply(h3k27me3_bw, FUN = function(x) {\n  normalizeToMatrix(x, mid_peaks,\n    extend = 1000,\n    value_column = \"score\",\n    include_target = TRUE,\n    mean_mode = \"w0\",\n    w = 20,\n    smooth = T,\n    background = 0\n  )\n})\n\nsaveRDS(mat_h3k27me3, file = \"output/mat_h3k27me3.rds\")\n```\n:::\n\n\n### H3K27ac\n\n::: {.cell}\n\n```{.r .cell-code}\nh3k27ac_files <- list.files(\"data\", pattern = \"H3K27ac\", full.names = TRUE)\nnames(h3k27ac_files) <- gsub(pattern = \"\\\\.bw\", replacement = \"\", x = basename(h3k27ac_files))\nh3k27ac_bw <- lapply(h3k27ac_files, function(x){\n  a <- rtracklayer::import(x)\n  a <- a[seqnames(a) %in% c(\"chr1\", \"chr2\")]\n  a\n})\n\nmat_h3k27ac <- lapply(h3k27ac_bw, FUN = function(x) {\n  normalizeToMatrix(x, mid_peaks,\n    extend = 1000,\n    value_column = \"score\",\n    include_target = TRUE,\n    mean_mode = \"w0\",\n    w = 20,\n    smooth = T,\n    background = 0\n  )\n})\n\nsaveRDS(mat_h3k27ac, file = \"output/mat_h3k27ac.rds\")\n```\n:::\n\n\n## RNA\n\n::: {.cell}\n\n```{.r .cell-code}\n# Match overlapping peak names with RNA-seq gene names\ntmp <- elementMetadata(overlap)[,c(\"RNA_Row.names\", \"name\")]\n\n# Get logCPM matrix\ncounts <- assay(rna, \"logCPM\")\ncounts <- assay(rna, \"logCPM\") - rowMeans(\n  assay(rna, \"logCPM\")[, grep(pattern = \"11half\", x = colnames(assay(rna, \"logCPM\")),\n                              value = T)]\n)\n\n# Merge gene expression values with peaks\nmat_RNA <- merge(tmp, counts, by.x = \"RNA_Row.names\", by.y = \"row.names\", all.x = T)\n\n# Set rownames to peak names and cleanup\nrownames(mat_RNA) <- mat_RNA$name\nmat_RNA <- mat_RNA[,-c(1:2)]\ncolnames(mat_RNA) <- gsub(pattern = \".tsv.gz\", replacement = \"\", x = colnames(mat_RNA))\nmat_RNA <- data.matrix(mat_RNA)\nmat_RNA <- mat_RNA[names(overlap),]\n\n# Save data\nsaveRDS(mat_RNA, file = \"output/mat_rna.rds\")\n```\n:::\n\n\n## WGBS\n\n::: {.cell}\n\n```{.r .cell-code}\n# Bisulfite seq coverage files after methylation call\nbs_files <- list.files(\"data\", pattern = \"WGBS\", full.names = TRUE)\nnames(bs_files) <- gsub(pattern = \"\\\\.bed.gz\", replacement = \"\", x = basename(bs_files))\n\n# Reading coverage\nbs_cov <- lapply(bs_files, function(x) {\n  GRanges(  \n  fread(\n      input = x,\n      sep = \" \", quote = F, stringsAsFactors = F,\n      data.table = FALSE, nThread = parallel::detectCores(), showProgress = F,\n      col.names = c(\"seqnames\", \"start\", \"end\", \"cov\", \"Me\", \"Un\", \"meth\")\n    )\n  )\n})\n\n# Normalized matrics\nmat_bs <- lapply(bs_cov, FUN = function(x) {\n    normalizeToMatrix(x, mid_peaks,\n      extend = 1000,\n      value_column = \"meth\",\n      include_target = TRUE,\n      smooth = TRUE,\n      mean_mode = \"absolute\",\n      background = NA\n    )\n})\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nAll signal values are within [0, 1], so we assume it is methylation\nsignal. Automatically set limit [0, 1] to the smoothed values. If this\nis not the case, set argument `limit = NA` in the function to remove\nthe limits. Set `verbose = FALSE` to turn off this message.\n```\n\n\n:::\n\n```{.r .cell-code}\nsaveRDS(mat_bs, file = \"output/mat_bs.rds\")\n```\n:::\n\n\n\n## Question 1\n**Make an `EnrichedHeatmap`** of methylation data.\n\n:::{.callout-tip collapse=\"true\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nEnrichedHeatmap(\n  mat = mat_bs$WGBS_11half,    # normalized matrix\n  name = \"E11.5\",              # Name for the plot\n  width = unit(4, \"cm\"),       # Width of the heatmap\n  height = unit(8, \"cm\")      # Height of the heatmap\n) + EnrichedHeatmap(\n  mat = mat_bs$WGBS_15half,    # normalized matrix\n  name = \"E15.5\",              # Name for the plot\n  width = unit(4, \"cm\"),       # Width of the heatmap\n  height = unit(8, \"cm\")      # Height of the heatmap\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe automatically generated colors map from the 1^st and 99^th of the\nvalues in the matrix. There are outliers in the matrix whose patterns\nmight be hidden by this color mapping. You can manually set the color\nto `col` argument.\n\nUse `suppressMessages()` to turn off this message.\nThe automatically generated colors map from the 1^st and 99^th of the\nvalues in the matrix. There are outliers in the matrix whose patterns\nmight be hidden by this color mapping. You can manually set the color\nto `col` argument.\n\nUse `suppressMessages()` to turn off this message.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](day2-1_overlap_matrix_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n:::\n\n:::{.callout-important}\nWe have not performed differential analysis for DNA methylation data. If you want, you can. Here, we are using DNA methylation as an observartory mark.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}